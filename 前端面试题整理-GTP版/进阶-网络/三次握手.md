# 三次握手

HTTP 协议是一种无状态的协议，通常基于 TCP 协议进行数据传输。HTTP 协议的三次握手并不是指 HTTP 协议本身的握手过程，而是指在建立基于 TCP 协议的连接时的三次握手过程。下面是 HTTP 协议基于 TCP 的三次握手过程：

1. **客户端发送 SYN 请求：**
   - 客户端（Client）向服务器（Server）发送一个 SYN 包（同步序列编号），表示客户端请求建立 TCP 连接。
   - SYN 包中包含客户端的初始序列号（ISN）。
   
2. **服务器确认 SYN 请求并发送 SYN+ACK 包：**
   - 服务器收到 SYN 请求后，会发送一个 SYN+ACK 包（同步应答序列编号），表示接受客户端的请求，并确认建立 TCP 连接。
   - SYN+ACK 包中包含服务器的初始序列号（ISN）和确认号（ACK）。

3. **客户端发送 ACK 确认连接建立：**
   - 客户端收到服务器的 SYN+ACK 包后，会发送一个 ACK 包（确认序列编号），表示接受服务器的连接请求，并确认建立 TCP 连接。
   - ACK 包中包含客户端确认号（ACK）。

经过这样的三次握手过程，客户端和服务器之间建立了可靠的 TCP 连接，可以进行数据传输。这个过程的目的是确保双方都能够正确地识别和确认对方，并建立一个可靠的数据传输通道。当数据传输完成后，连接可以通过四次挥手来关闭连接。

值得注意的是，HTTP 协议是应用层协议，它位于 OSI 模型中的第七层，而 TCP 协议是传输层协议，位于 OSI 模型中的第四层。HTTP 协议通过 TCP 协议来传输数据，所以在建立 HTTP 连接时需要进行 TCP 的三次握手过程。

# 四次挥手

在浏览器和服务器之间建立和关闭一个 TCP 连接的过程中，会涉及到三次握手和四次挥手的过程。这是 TCP 协议的一部分，用于确保连接的可靠性。这里，我们将详细讲解四次挥手的过程。

### 四次挥手（TCP 连接的关闭）

四次挥手是用来安全地关闭一个 TCP 连接的过程，确保双方都能够正确地接收和发送最后的数据包。它涉及到双方发送和接收四个控制消息（FIN 和 ACK）。

#### 过程概述

1. **第一步（FIN，主动关闭）**：
   - 客户端（主动关闭方）发送一个 FIN 包，表示它已经完成了数据发送，准备关闭连接。
   - 这个 FIN 包会包含一个序列号 `seq = x`。

   ```
   客户端 ----FIN----> 服务器
   ```

2. **第二步（ACK，服务器确认）**：
   - 服务器收到 FIN 包后，发送一个 ACK 包作为响应，表示它已经接收到了客户端的 FIN 包。
   - ACK 包会包含一个确认号 `ack = x + 1`，表示确认了 FIN 包的序列号。

   ```
   客户端 <---ACK---- 服务器
   ```

3. **第三步（FIN，服务器关闭）**：
   - 服务器也发送一个 FIN 包，表示它已经完成了数据发送，准备关闭连接。
   - 这个 FIN 包会包含一个序列号 `seq = y`。

   ```
   客户端 <---FIN---- 服务器
   ```

4. **第四步（ACK，客户端确认）**：
   - 客户端收到服务器的 FIN 包后，发送一个 ACK 包作为响应，表示它已经接收到了服务器的 FIN 包。
   - ACK 包会包含一个确认号 `ack = y + 1`。

   ```
   客户端 ----ACK---> 服务器
   ```

在这四次挥手之后，双方的连接就正式关闭了。

### 详细步骤解析

假设客户端想要关闭连接，服务器作为被动关闭方：

1. **第一步（客户端发送 FIN 包）**：
   - 客户端：`发送 FIN 包，seq = x`
   - 进入 `FIN_WAIT_1` 状态

2. **第二步（服务器发送 ACK 包）**：
   - 服务器：`接收 FIN 包，发送 ACK 包，ack = x + 1`
   - 客户端：`接收 ACK 包，进入 FIN_WAIT_2 状态`

3. **第三步（服务器发送 FIN 包）**：
   - 服务器：`发送 FIN 包，seq = y`
   - 进入 `CLOSE_WAIT` 状态

4. **第四步（客户端发送 ACK 包）**：
   - 客户端：`接收 FIN 包，发送 ACK 包，ack = y + 1`
   - 进入 `TIME_WAIT` 状态（等待一段时间以确保服务器收到了 ACK 包）

5. **服务器进入 `CLOSED` 状态**：
   - 服务器：`接收 ACK 包，进入 CLOSED 状态`

6. **客户端完成 `TIME_WAIT` 计时后进入 `CLOSED` 状态**：
   - 客户端：`在 TIME_WAIT 状态等待一段时间后，进入 CLOSED 状态`

### 为什么需要四次挥手？

四次挥手的设计是为了确保双方都能完全关闭连接，且所有数据都能被正确传输和确认。这种机制确保了：

1. **数据的完整性和可靠性**：通过 FIN 和 ACK 包的相互确认，确保双方都完成了数据传输。
2. **避免数据丢失**：客户端在进入 `TIME_WAIT` 状态时，会等待一个足够长的时间（通常是两倍的最大报文段生存时间，2MSL），以确保服务器收到了最后的 ACK 包，从而避免数据丢失。

### 总结

四次挥手是 TCP 协议中关闭连接的重要步骤，涉及到双方发送和接收四个控制消息（FIN 和 ACK）。这保证了连接的可靠关闭，确保所有数据都能被正确传输和确认。理解这一过程对网络编程和调试网络问题非常重要。